name: Deploy Backend to Digital Ocean

on:
  push:
    branches:
      - main
    paths:
      - 'teoria-sintergica/brain-prototype/backend/**'
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "ï¿½ Configurando git safe directory..."
          git config --global --add safe.directory /home/brain/random
          
          echo "ğŸ”„ Actualizando cÃ³digo..."
          cd /home/brain/random
          git fetch origin main
          git reset --hard origin/main
          
          echo "ğŸ“¦ Instalando dependencias..."
          cd teoria-sintergica/brain-prototype/backend
          source venv/bin/activate
          pip install -r requirements.txt --quiet
          
          echo "â™»ï¸  Reiniciando servicio..."
          sudo systemctl restart brain-backend
          
          echo "â³ Esperando a que el servicio inicie..."
          sleep 15
          
          echo "âœ… Verificando estado del servicio..."
          sudo systemctl status brain-backend --no-pager | head -10
          
          echo ""
          echo "ğŸ“‹ Ãšltimos logs del servicio (incluyendo errores)..."
          sudo journalctl -u brain-backend -n 50 --no-pager | grep -E "(ERROR|Exception|Traceback|automation)" || sudo journalctl -u brain-backend -n 30 --no-pager
          
          echo ""
          echo "ğŸ§ª Probando health check..."
          curl -s http://localhost:8000/ || echo "âš ï¸  Backend aÃºn no responde"
          
          echo ""
          echo "ğŸ§ª Probando automation endpoint..."
          curl -v http://localhost:8000/automation/dashboard 2>&1 | head -20
          
          echo ""
          echo "ğŸ” Verificando logs despuÃ©s del request..."
          sleep 2
          sudo journalctl -u brain-backend -n 20 --no-pager | tail -10

    - name: ğŸ‰ Deployment Success
      run: |
        echo "âœ… Backend deployed successfully!"
        echo "ğŸŒ API: http://api.random-studio.io"
