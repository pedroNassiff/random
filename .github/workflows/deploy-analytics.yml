name: Deploy Analytics to Production

on:
  workflow_dispatch:  # Solo ejecuciÃ³n manual
    inputs:
      confirm:
        description: 'Â¿Confirmas el deployment de analytics?'
        required: true
        default: 'yes'

jobs:
  deploy-analytics:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'yes'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy Analytics Module
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "ğŸ”„ Actualizando cÃ³digo completo..."
          cd /home/brain/random
          git pull origin main
          
          echo "ğŸ“¦ Verificando mÃ³dulo analytics..."
          cd teoria-sintergica/brain-prototype/backend
          ls -la analytics/
          
          echo "ğŸ“¦ Instalando dependencias de analytics..."
          source venv/bin/activate
          pip install asyncpg influxdb-client psycopg2-binary --quiet
          
          echo "ğŸ“‹ Actualizando requirements.txt..."
          pip freeze > requirements.txt
          
          echo "â™»ï¸  Reiniciando servicio backend..."
          sudo systemctl restart brain-backend
          
          echo "â³ Esperando a que el servicio inicie..."
          sleep 8
          
          echo "âœ… Verificando estado del servicio..."
          sudo systemctl status brain-backend --no-pager | head -15
          
          echo "ğŸ§ª Probando endpoint de analytics..."
          sleep 2
          curl -s http://localhost:8000/analytics/health || echo "âš ï¸  Endpoint aÃºn no responde"

    - name: ğŸ‰ Deployment Success
      run: |
        echo "âœ… Analytics deployed successfully!"
        echo "ğŸŒ Test: http://api.random-studio.io/analytics/health"
