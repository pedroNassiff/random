# /etc/nginx/sites-available/brain-backend
# ─────────────────────────────────────────────────────────────────────────────
# Hardened config for api.random-lab.es
# Apply:  sudo cp this-file /etc/nginx/sites-available/brain-backend
#         sudo nginx -t && sudo systemctl reload nginx
# ─────────────────────────────────────────────────────────────────────────────

# ─── Rate-limit zones (defined in http context — put in /etc/nginx/nginx.conf
#     http{} block or include this whole file via snippets) ───────────────────
#
#  Paste the limit_req_zone lines into /etc/nginx/nginx.conf inside http {}:
#
#  limit_req_zone  $binary_remote_addr  zone=api_general:10m  rate=60r/m;
#  limit_req_zone  $binary_remote_addr  zone=api_write:10m    rate=20r/m;
#  limit_req_zone  $binary_remote_addr  zone=api_heavy:10m    rate=10r/m;
#  limit_conn_zone $binary_remote_addr  zone=conn_limit:10m;
#
# Then reload: sudo systemctl reload nginx
# ─────────────────────────────────────────────────────────────────────────────

# ─── Bad-bot map ──────────────────────────────────────────────────────────────
# Add inside http {} in nginx.conf:
#
# map $http_user_agent $bad_bot {
#     default          0;
#     ~*sqlmap         1;
#     ~*nikto          1;
#     ~*masscan        1;
#     ~*nmap           1;
#     ~*dirbuster      1;
#     ~*gobuster       1;
#     ~*wfuzz          1;
#     ~*ffuf           1;
#     ~*nuclei         1;
#     ~*acunetix       1;
#     ~*nessus         1;
#     ~*openvas        1;
#     ~*python-requests/2\.2[0-9] 1;
#     ~*go-http-client/1\.1       1;
#     ""               1;   # empty UA = bot
# }
# ─────────────────────────────────────────────────────────────────────────────

server {
    server_name api.random-lab.es;

    # ── Logging ────────────────────────────────────────────────────────────
    access_log /var/log/nginx/brain-backend-access.log;
    error_log  /var/log/nginx/brain-backend-error.log  warn;

    # ── Basic limits ───────────────────────────────────────────────────────
    client_max_body_size     10M;     # down from 100M — no large uploads needed
    client_body_timeout      12s;
    client_header_timeout    12s;
    keepalive_timeout        15s;
    send_timeout             10s;

    # ── Security headers ───────────────────────────────────────────────────
    add_header X-Content-Type-Options   "nosniff"                        always;
    add_header X-Frame-Options          "DENY"                           always;
    add_header X-XSS-Protection         "1; mode=block"                  always;
    add_header Referrer-Policy          "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    # Hide server version
    server_tokens off;

    # ── Block bad bots immediately ─────────────────────────────────────────
    if ($bad_bot) {
        return 403;
    }

    # ── Block scanner paths ────────────────────────────────────────────────
    location ~* ^/(wp-admin|wp-login|wp-content|phpmyadmin|\.env|\.git|
                   \.htaccess|admin|config|cgi-bin|shell|eval|xmlrpc|
                   actuator|etc/passwd|proc/self|vendor/phpunit) {
        return 404;
    }

    # ── Block methods not used by this API ─────────────────────────────────
    if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS|HEAD)$ ) {
        return 405;
    }

    # ── Connection limit per IP ─────────────────────────────────────────────
    limit_conn conn_limit 20;

    # ── Analytics / Automation endpoints (heavy tier) ──────────────────────
    location ~ ^/(analytics|automation) {
        # Hard rate limit: 10 r/m, burst 5, no delay
        limit_req zone=api_heavy burst=5 nodelay;
        limit_req_status 429;

        # Write ops: extra strictness
        limit_except GET OPTIONS {
            limit_req zone=api_write burst=10 nodelay;
        }

        proxy_pass             http://127.0.0.1:8000;
        proxy_http_version     1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade           $http_upgrade;
        proxy_set_header Connection        "upgrade";

        # Tighter timeouts for API calls (not EEG streaming)
        proxy_connect_timeout  10s;
        proxy_send_timeout     30s;
        proxy_read_timeout     30s;
    }

    # ── WebSocket endpoint (EEG streaming — no rate limit, long timeout) ───
    location /ws {
        proxy_pass             http://127.0.0.1:8000;
        proxy_http_version     1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade           $http_upgrade;
        proxy_set_header Connection        "upgrade";

        proxy_connect_timeout  600s;
        proxy_send_timeout     600s;
        proxy_read_timeout     600s;
    }

    # ── All other endpoints (general tier) ─────────────────────────────────
    location / {
        limit_req zone=api_general burst=20 nodelay;
        limit_req_status 429;

        proxy_pass             http://127.0.0.1:8000;
        proxy_http_version     1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade           $http_upgrade;
        proxy_set_header Connection        "upgrade";

        proxy_connect_timeout  10s;
        proxy_send_timeout     30s;
        proxy_read_timeout     30s;
    }

    # ── SSL (managed by Certbot) ────────────────────────────────────────────
    listen [::]:443 ssl ipv6only=on;
    listen 443 ssl;
    ssl_certificate     /etc/letsencrypt/live/api.random-lab.es/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.random-lab.es/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;
}

# ── HTTP → HTTPS redirect ────────────────────────────────────────────────────
server {
    listen 80;
    listen [::]:80;
    server_name api.random-lab.es;
    return 301 https://$host$request_uri;
}
